# frozen_string_literal: true

require_relative 'cis_remediation'

class CIS_RHEL8_5_4_1 < CISRemediation
  def initialize
    super('CIS_RHEL8_5_4_1')
    @title = 'Ensure password creation requirements are configured (Scored)'
    @scored = true
    @level = 1
    @identifier = '5.4.1'
    @description = '
    "5.4.1 Ensure password creation requirements are configured (Scored)\nProfile Applicability:\n Level 1 - Server\n Level 1 - Workstation\nDescription:\nThe pam_pwquality.so module checks the strength of passwords. It performs checks such as making sure a password is not a dictionary word, it is a certain length, contains a mix of characters (e.g. alphabet, numeric, \nother) and more. The following are definitions of the pam_pwquality.so options.\n try_first_pass - retrieve the password from a previous stacked PAM module. If not available, then prompt the user for a password.\n retry=3 - Allow 3 tries before sending back a failure.\n minlen=14 - password must be 14 characters or more\n** Either of the following can be used to enforce complex passwords:**\n minclass=4 - provide at least four classes of characters for the new password\nOR\nThe settings shown above are one possible policy. Alter these values to conform to your own organizations password policies\nRationale:\nStrong passwords protect systems from being hacked through brute force methods.\n dcredit=-1 - provide at least one digit\n ucredit=-1 - provide at least one uppercase character\n ocredit=-1 - provide at least one special character\n lcredit=-1 - provide at least one lowercase character\n\nAudit:\nVerify password creation requirements conform to organization policy:\nRun the following command and verify that retry conforms to organization policy.\n# grep pam_pwquality.so /etc/pam.d/system-auth /etc/pam.d/password-auth\nOutput should be similar to:\nRun the following commands and verify password length requirements conform to organization policy.\n# grep ^minlen /etc/security/pwquality.conf\nVerify minlen is 14 or more\nRun one of the following commands and verify that password complexity conforms to organization policy.\n# grep ^minclass /etc/security/pwquality.conf\nOR\n# grep -E \"^\s*\Scredit\s*=\" /etc/security/pwquality.conf\n               /etc/pam.d/system-auth:password requisite pam_pwquality.so try_first_pass local_users_only enforce-for-root retry=3\n/etc/pam.d/password-auth:password requisite pam_pwquality.so try_first_pass local_users_only enforce-for-root retry=3\n\nRemediation:\nEdit the file /etc/security/pwquality.conf and add or modify the following line for password length to conform to site policy\nminlen = 14\nEdit the file /etc/security/pwquality.conf and add or modify the following line for password complexity to conform to site policy\nminclass = 4\nOR\nRun the following to update the system-auth and password-auth files\n                        dcredit = -1\nucredit = -1\nocredit = -1\nlcredit = -1\n               CP=$(authselect current | awk NR == 1 {print $3} | grep custom/) for FN in system-auth password-auth; do\n[[ -n $CP ]] && PTF=/etc/authselect/$CP/$FN || PTF=/etc/authselect/$FN\n[[ -z $(grep -E ^\s*password\s+requisite\s+pam_pwquality.so\s+.*enforce-for-root\s*.*$ $PTF) ]] && sed -ri s/^\s*(password\s+requisite\s+pam_pwquality.so\s+)(.*)$/\1\2 enforce-for- root/ $PTF\n[[ -n $(grep -E ^\s*password\s+requisite\s+pam_pwquality.so\s+.*\s+retry=\S+\s*.*$ $PTF) ]] && sed -ri /pwquality/s/retry=\S+/retry=3/ $PTF || sed -ri s/^\s*(password\s+requisite\s+pam_pwquality.so\s+)(.*)$/\1\2 \nretry=3/ $PTF done\nauthselect apply-changes\n                             Notes:\nall default authselect profiles have pam_pwquality enabled with the expectation that options will be specified in pwquality.conf\nCIS Controls:\nVersion 7\n4.4 Use Unique Passwords\nWhere multi-factor authentication is not supported (such as local administrator, root, or service accounts), accounts will use passwords that are unique to that system.\n\n"
    '
    @script_file = 'CIS_RHEL8_5_4_1.sh'
    @commands = [{"script_bash"=>"bash #{@script_directory}/CIS_RHEL8_5_4_1.sh"}]
  end
end
