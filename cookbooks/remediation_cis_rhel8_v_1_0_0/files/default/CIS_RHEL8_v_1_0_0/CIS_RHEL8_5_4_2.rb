# frozen_string_literal: true

require_relative 'cis_remediation'

class CIS_RHEL8_5_4_2 < CISRemediation
  def initialize
    super('CIS_RHEL8_5_4_2')
    @title = 'Ensure lockout for failed password attempts is configured (Scored)'
    @scored = true
    @level = 1
    @identifier = '5.4.2'
    @description = '
    "5.4.2 Ensure lockout for failed password attempts is configured (Scored)\nProfile Applicability:\n Level 1 - Server\n Level 1 - Workstation\nDescription:\nLock out users after n unsuccessful consecutive login attempts.\n deny= - Number of attempts before the account is locked\n unlock_time= - Time in seconds before the account is unlocked\nSet the lockout number and unlock time to follow local site policy.\nRationale:\nLocking out user 5.4.2s after n unsuccessful consecutive login attempts mitigates brute force password attacks against your systems.\nAudit:\nVerify password lockouts are configured. These settings are commonly configured with the pam_tally2.so and pam_failock.so modules found in /etc/pam.d/common-auth or /etc/pam.d/system-auth and /etc/pam.d/password-auth \n. Examples:\nRun the following command are review the output to ensure that it follow local site policy. deny should be no greater that 5 and unlock_time should be no less than 900 seconds\nOutput should look similar to:\n      # grep -E ^\s*auth\s+required\s+pam_faillock.so\s+ /etc/pam.d/password-auth /etc/pam.d/system-auth\n           /etc/pam.d/password-auth:auth required pam_faillock.so preauth silent\n   deny=5 unlock_time=900\n/etc/pam.d/password-auth:auth\ndeny=5 unlock_time=900\n/etc/pam.d/system-auth:auth\ndeny=5 unlock_time=900\n/etc/pam.d/system-auth:auth\ndeny=5 unlock_time=900\nrequired\nrequired\nrequired\npam_faillock.so authfail\npam_faillock.so preauth silent\npam_faillock.so authfail\n\nRemediation:\nSet password lockouts and unlock times to conform to site policy\nRun the following to update the system-auth and password-auth files. This script will update/add the deny=5 and unlock_time=900 options.\nThis script should be modified as needed to follow local site policy.\n      CP=$(authselect current | awk NR == 1 {print $3} | grep custom/) for FN in system-auth password-auth; do\n[[ -n $CP ]] && PTF=/etc/authselect/$CP/$FN || PTF=/etc/authselect/$FN\n[[ -n $(grep -E ^\s*auth\s+required\s+pam_faillock.so\s+.*deny=\S+\s*.*$ $PTF) ]] && sed - ri /pam_faillock.so/s/deny=\S+/deny=5/g $PTF || sed -ri\n             s/^\^\s*(auth\s+required\s+pam_faillock\.so\s+)(.*[^{}])(\{.*\}|)$/\1\2 deny=5 \3/ $PTF\n[[ -n $(grep -E ^\s*auth\s+required\s+pam_faillock.so\s+.*unlock_time=\S+\s*.*$ $PTF) ]] && sed -ri /pam_faillock.so/s/unlock_time=\S+/unlock_time=900/g $PTF || sed - ri \ns/^\s*(auth\s+required\s+pam_faillock\.so\s+)(.*[^{}])(\{.*\}|)$/\1\2 unlock_time=900 \3/ $PTF\ndone\nauthselect apply-changes\n                   Notes:\nAdditional module options may be set, recommendation only covers those listed here.\nIf a user has been locked out because they have reached the maximum consecutive failure count defined by deny= in the pam_faillock.so module, the user can be unlocked by issuing the command faillock -u --reset. This \ncommand sets the failed count to 0, effectively unlocking the user.\nUse of the \"audit\" keyword may log credentials in the case of user error during authentication. This risk should be evaluated in the context of the site policies of your organization.\nCIS Controls:\nVersion 7\n16.7 Establish Process for Revoking Access\nEstablish and follow an automated process for revoking system access by disabling accounts immediately upon termination or change of responsibilities of an employee or contractor . Disabling these accounts, instead \nof deleting accounts, allows preservation of audit trails.\n\n"
    '
    @script_file = 'CIS_RHEL8_5_4_2.sh'
    @commands = [{"script_bash"=>"bash #{@script_directory}/CIS_RHEL8_5_4_2.sh"}]
  end
end
