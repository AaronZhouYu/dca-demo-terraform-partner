# frozen_string_literal: true

require_relative 'cis_remediation'

class CIS_RHEL8_3_4_3_8 < CISRemediation
  def initialize
    super('CIS_RHEL8_3_4_3_8')
    @title = 'Ensure nftables rules are permanent (Scored)'
    @scored = true
    @level = 1
    @identifier = '3.4.3.8'
    @description = '
    "3.4.3.8 Ensure nftables rules are permanent (Scored)\nProfile Applicability:\n Level 1 - Server\n Level 1 - Workstation\nDescription:\nnftables is a subsystem of the Linux kernel providing filtering and classification of network packets/datagrams/frames.\nThe nftables service reads the /etc/sysconfig/nftables.conf file for a nftables file or files to include in the nftables ruleset.\nA nftables ruleset containing the input, forward, and output base chains allow network traffic to be filtered.\nRationale:\nChanges made to nftables ruleset only affect the live system, you will also need to configure the nftables ruleset to apply on boot\n\nAudit:\nRun the following commands to verify that input, forward, and output base chains are configured to be applied to a nftables ruleset on boot:\nRun the following command to verify the input base chain:\nOutput should be similar to:\n      # awk /hook input/,/}/ $(awk $1 ~ /^\s*include/ { gsub(\"\\"\",\"\",$2);print $2 } /etc/sysconfig/nftables.conf)\n           type filter hook input priority 0; policy drop;\n     # Ensure loopback traffic is configured\niif \"lo\" accept\nip saddr 127.0.0.0/8 counter packets 0 bytes 0 drop ip6 saddr ::1 counter packets 0 bytes 0 drop\n# Ensure established connections are configured ip protocol tcp ct state established accept\nip protocol udp ct state established accept\nip protocol icmp ct state established accept\n# Accept port 22(SSH) traffic from anywhere tcp dport ssh accept\n                # Accept ICMP and IGMP from anywhere\nicmpv6 type { destination-unreachable, packet-too-big, time- exceeded, parameter-problem, mld-listener-query, mld-listener-report, mld- listener-done, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd- \nneighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener- report } accept\n                                       Note: Review the input base chain to ensure that it follows local site policy Run the following command to verify the forward base chain:\nOutput should be similar to:\nNote: Review the forward base chain to ensure that it follows local site policy.\n      # awk /hook forward/,/}/ $(awk $1 ~ /^\s*include/ { gsub(\"\\"\",\"\",$2);print $2 } /etc/sysconfig/nftables.conf)\n           # Base chain for hook forward named forward (Filters forwarded network packets)\nchain forward {\ntype filter hook forward priority 0; policy drop;\n}\n\nRun the following command to verify the output base chain:\nOutput should be similar to:\n      # awk /hook output/,/}/ $(awk $1 ~ /^\s*include/ { gsub(\"\\"\",\"\",$2);print $2 } /etc/sysconfig/nftables.conf)\n           # Base chain for hook output named output (Filters outbound network packets)\nchain output {\ntype filter hook output priority 0; policy drop;\n# Ensure outbound and established connections are configured ip protocol tcp ct state established,related,new accept\nip protocol tcp ct state established,related,new accept\n               ip protocol udp ct state established,related,new accept ip protocol icmp ct state established,related,new accept\n    }\n   Note: Review the output base chain to ensure that it follows local site policy.\nRemediation:\nEdit the /etc/sysconfig/nftables.conf file and un-comment or add a line with include <Absolute path to nftables rules file> for each nftables file you want included in the nftables ruleset on boot\nexample:\n# vi /etc/sysconfig/nftables.conf\nAdd the line:\ninclude \"/etc/nftables/nftables.rules\"\nCIS Controls:\nVersion 7\n9.4 Apply Host-based Firewalls or Port Filtering\nApply host-based firewalls or port filtering tools on end systems, with a default-deny rule that drops all traffic except those services and ports that are explicitly allowed.\n\n3.4.4.1 Configure IPv4 iptables\nIptables is used to set up, maintain, and inspect the tables of IP packet filter rules in the Linux kernel. Several different tables may be defined. Each table contains a number of built-in chains and may also \ncontain user-defined chains.\nEach chain is a list of rules which can match a set of packets. Each rule specifies what to do with a packet that matches. This is called a target, which may be a jump to a user-defined chain in the same table.\nNote: This section broadly assumes starting with an empty IPtables firewall ruleset (established by flushing the rules with iptables -F). Remediation steps included only affect the live system, you will also need to \nconfigure your default firewall configuration to apply on boot. Configuration of a live systems firewall directly over a remote connection will often result in being locked out. It is advised to have a known good \nfirewall configuration set to run on boot and to configure an entire firewall structure in a script that is then run and tested before saving to boot. The following script will implement the firewall rules of this \nsection and open port 22(ssh) from anywhere. This needs to be updated to only allow systems requiring ssh connectivity to connect as per site policy.\n\n      #!/bin/bash\n# Flush IPtables rules\niptables -F\n# Ensure default deny firewall policy\niptables -P INPUT DROP\n               iptables -P OUTPUT DROP\niptables -P FORWARD DROP\n# Ensure loopback traffic is configured\niptables -A INPUT -i lo -j ACCEPT\niptables -A OUTPUT -o lo -j ACCEPT\niptables -A INPUT -s 127.0.0.0/8 -j DROP\n# Ensure outbound and established connections are configured\niptables -A OUTPUT -p tcp -m state --state NEW,ESTABLISHED -j ACCEPT iptables -A OUTPUT -p udp -m state --state NEW,ESTABLISHED -j ACCEPT iptables -A OUTPUT -p icmp -m state --state NEW,ESTABLISHED -j ACCEPT iptables \n-A INPUT -p tcp -m state --state ESTABLISHED -j ACCEPT iptables -A INPUT -p udp -m state --state ESTABLISHED -j ACCEPT iptables -A INPUT -p icmp -m state --state ESTABLISHED -j ACCEPT\n                                 # Open inbound ssh(tcp port 22) connections\niptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT\n\n"
    '
    @script_file = ''
    @commands = [{"local"=>"echo 'Automated remediation unavailable. Please remediate manually:\n\nEdit the /etc/sysconfig/nftables.conf file and un-comment or add a line with include <Absolute path to nftables rules file> for each nftables file you want included in the nftables ruleset on boot\n\nexample:\n# vi /etc/sysconfig/nftables.conf\n\nAdd the line:\ninclude \"/etc/nftables/nftables.rules\"'\n"}]
  end
end
