# frozen_string_literal: true

require_relative 'cis_remediation'

class CIS_RHEL8_3_4_4_1_4 < CISRemediation
  def initialize
    super('CIS_RHEL8_3_4_4_1_4')
    @title = 'Ensure firewall rules exist for all open ports (Scored)'
    @scored = true
    @level = 1
    @identifier = '3.4.4.1.4'
    @description = '
    "3.4.4.1.4 Ensure firewall rules exist for all open ports (Scored)\nProfile Applicability:\n Level 1 - Server\n Level 1 - Workstation\nDescription:\nAny ports that have been opened on non-loopback addresses need firewall rules to govern traffic.\nRationale:\nWithout a firewall rule configured for open ports default firewall policy will drop all packets to these ports.\nAudit:\nRun the following command to determine open ports:\n      # ss -4tuln\nNetid  State\nAddress:Port\nudp    UNCONN\n*:*\nudp    UNCONN\n*:*\ntcp    LISTEN\n*:*\nRecv-Q Send-Q\n0      0\n0      0\n0      128\nLocal Address:Port                   Peer\n            *:68\n*:123 *:22\n                     Run the following command to determine firewall rules:\n      # iptables -L INPUT -v -n\nChain INPUT (policy DROP 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source\ndestination\n             0     0 ACCEPT\n    0     0 DROP\n    0     0 ACCEPT\ntcp dpt:22 state NEW\nall  --  lo     *\nall  --  *      *\ntcp  --  *      *\n0.0.0.0/0\n127.0.0.0/8\n0.0.0.0/0\n0.0.0.0/0\n0.0.0.0/0\n0.0.0.0/0\n         Verify all open ports listening on non-localhost addresses have at least one firewall rule. The last line identified by the \"tcp dpt:22 state NEW\" identifies it as a firewall rule for new connections on tcp \nport 22.\n\nRemediation:\nFor each port identified in the audit which does not have a firewall rule establish a proper rule for accepting inbound connections:\nNotes:\nChanging firewall settings while connected over network can result in being locked out of the system.\nRemediation will only affect the active system firewall, be sure to configure the default policy in your firewall management to apply on boot as well.\nThe remediation command opens up the port to traffic from all sources. Consult iptables documentation and set any restrictions in compliance with site policy.\nCIS Controls:\nVersion 7\n9.2 Ensure Only Approved Ports, Protocols and Services Are Running\nEnsure that only network ports, protocols, and services listening on a system with validated business needs, are running on each system.\n9.4 Apply Host-based Firewalls or Port Filtering\nApply host-based firewalls or port filtering tools on end systems, with a default-deny rule that drops all traffic except those services and ports that are explicitly allowed.\n      # iptables -A INPUT -p <protocol> --dport <port> -m state --state NEW -j ACCEPT\n\n3.4.4.2 Configure IPv6 ip6tables\nIp6tables is used to set up, maintain, and inspect the tables of IPv6 packet filter rules in the Linux kernel. Several different tables may be defined. Each table contains a number of built-in chains and may also \ncontain user-defined chains. Each chain is a list of rules which can match a set of packets. Each rule specifies what to do with a packet that matches. This is called a `target, which may be a jump to a user-defined \nchain in the same table.\nIf IPv6 in enabled on the system, the ip6tables should be configured.\nNote: This section broadly assumes starting with an empty ip6tables firewall ruleset (established by flushing the rules with ip6tables -F). Remediation steps included only affect the live system, you will also need \nto configure your default firewall configuration to apply on boot. Configuration of a live systems firewall directly over a remote connection will often result in being locked out. It is advised to have a known good \nfirewall configuration set to run on boot and to configure an entire firewall structure in a script that is then run and tested before saving to boot. The following script will implement the firewall rules of this \nsection and open port 22(ssh) from anywhere. This needs to be updated to only allow systems requiring ssh connectivity to connect as per site policy.\n\n      #!/bin/bash\n# Flush ip6tables rules\nip6tables -F\n# Ensure default deny firewall policy\nip6tables -P INPUT DROP\n               ip6tables -P OUTPUT DROP\nip6tables -P FORWARD DROP\n# Ensure loopback traffic is configured\nip6tables -A INPUT -i lo -j ACCEPT\nip6tables -A OUTPUT -o lo -j ACCEPT\nip6tables -A INPUT -s ::1 -j DROP\n# Ensure outbound and established connections are configured\nip6tables -A OUTPUT -p tcp -m state --state NEW,ESTABLISHED -j ACCEPT ip6tables -A OUTPUT -p udp -m state --state NEW,ESTABLISHED -j ACCEPT ip6tables -A OUTPUT -p icmp -m state --state NEW,ESTABLISHED -j ACCEPT \nip6tables -A INPUT -p tcp -m state --state ESTABLISHED -j ACCEPT ip6tables -A INPUT -p udp -m state --state ESTABLISHED -j ACCEPT ip6tables -A INPUT -p icmp -m state --state ESTABLISHED -j ACCEPT\n                                 # Open inbound ssh(tcp port 22) connections\nip6tables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT\n\n"
    '
    @script_file = ''
    @commands = [{"local"=>"echo 'Automated remediation unavailable. Please remediate manually:\n\nFor each port identified in the audit which does not have a firewall rule establish a proper rule for accepting inbound connections:\n# iptables -A INPUT -p <protocol> --dport <port> -m state --state NEW -j ACCEPT'\n"}]
  end
end
