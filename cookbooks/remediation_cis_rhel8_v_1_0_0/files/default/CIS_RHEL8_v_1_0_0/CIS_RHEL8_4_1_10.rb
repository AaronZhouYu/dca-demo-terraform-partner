# frozen_string_literal: true

require_relative 'cis_remediation'

class CIS_RHEL8_4_1_10 < CISRemediation
  def initialize
    super('CIS_RHEL8_4_1_10')
    @title = 'Ensure unsuccessful unauthorized file access attempts are collected (Scored)'
    @scored = true
    @level = 2
    @identifier = '4.1.10'
    @description = '
    "4.1.10 Ensure unsuccessful unauthorized file access attempts are collected (Scored)\nProfile Applicability:\n Level 2 - Server\n Level 2 - Workstation\nDescription:\nMonitor for unsuccessful attempts to access files. The parameters below are associated with system calls that control creation ( creat ), opening ( open , openat ) and truncation ( truncate , ftruncate ) of files. An \naudit log record will only be written if the user is a non- privileged user (auid > = 1000), is not a Daemon event (auid=4294967295) and if the system call returned EACCES (permission denied to the file) or EPERM \n(some other permanent error associated with the specific system call). All audit records will be tagged with the identifier \"access.\"\nNote: Systems may have been customized to change the default U4.1.10_MIN. To confirm the U4.1.10_MIN for your system, run the following command:\nawk /^\s*U4.1.10_MIN/{print $2} /etc/login.defs\nIf your systems U4.1.10_MIN is not 1000, replace audit>=1000 with audit>=<U4.1.10_MIN for your system> in the Audit and Remediation procedures.\nRationale:\nFailed attempts to open, create or truncate files could be an indication that an individual or process is trying to gain unauthorized access to the system.\n\nAudit:\nRun the following commands:\n# grep access /etc/audit/rules.d/*.rules\nVerify output matches:\n               -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access -a always,exit -F arch=b32 -S creat -S open -S openat -S \ntruncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k \naccess\n             -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access\n# auditctl -l | grep access\n       Verify output matches:\n      -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=-1 -k access\n-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=-1 -k access\n-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=-1 -k access\n-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=-1 -k access\n\nRemediation:\nEdit or create a file in the /etc/audit/rules.d/ directory ending in .rules Example: vi /etc/audit/rules.d/access.rules\nand add the following lines:\n      -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S \nftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access -a \nalways,exit -F arch=b32 -S creat -S open -S openat -S truncate -S\n               ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access\n   Notes:\nReloading the auditd config to set active settings may require a system reboot.\nCIS Controls:\nVersion 7\n14.9 Enforce Detail Logging for Access or Changes to Sensitive Data\nEnforce detailed audit logging for access to sensitive data or changes to sensitive data (utilizing tools such as File Integrity Monitoring or Security Information and Event Monitoring).\n\n"
    '
    @script_file = 'CIS_RHEL8_4_1_10.sh'
    @commands = [{"script_bash"=>"bash #{@script_directory}/CIS_RHEL8_4_1_10.sh"}]
  end
end
